/*
 * Apache License Version 2.0, January 2004 http://www.apache.org/licenses/
 *
 * TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
 *
 * 1. Definitions.
 *
 * "License" shall mean the terms and conditions for use, reproduction, and distribution as defined by Sections 1
 * through 9 of this document.
 *
 * "Licensor" shall mean the copyright owner or entity authorized by the copyright owner that is granting the License.
 *
 * "Legal Entity" shall mean the union of the acting entity and all other entities that control, are controlled by, or
 * are under common control with that entity. For the purposes of this definition, "control" means (i) the power, direct
 * or indirect, to cause the direction or management of such entity, whether by contract or otherwise, or (ii) ownership
 * of fifty percent (50%) or more of the outstanding shares, or (iii) beneficial ownership of such entity.
 *
 * "You" (or "Your") shall mean an individual or Legal Entity exercising permissions granted by this License.
 *
 * "Source" form shall mean the preferred form for making modifications, including but not limited to software source
 * code, documentation source, and configuration files.
 *
 * "Object" form shall mean any form resulting from mechanical transformation or translation of a Source form, including
 * but not limited to compiled object code, generated documentation, and conversions to other media types.
 *
 * "Work" shall mean the work of authorship, whether in Source or Object form, made available under the License, as
 * indicated by a copyright notice that is included in or attached to the work (an example is provided in the Appendix
 * below).
 *
 * "Derivative Works" shall mean any work, whether in Source or Object form, that is based on (or derived from) the Work
 * and for which the editorial revisions, annotations, elaborations, or other modifications represent, as a whole, an
 * original work of authorship. For the purposes of this License, Derivative Works shall not include works that remain
 * separable from, or merely link (or bind by name) to the interfaces of, the Work and Derivative Works thereof.
 *
 * "Contribution" shall mean any work of authorship, including the original version of the Work and any modifications or
 * additions to that Work or Derivative Works thereof, that is intentionally submitted to Licensor for inclusion in the
 * Work by the copyright owner or by an individual or Legal Entity authorized to submit on behalf of the copyright
 * owner. For the purposes of this definition, "submitted" means any form of electronic, verbal, or written
 * communication sent to the Licensor or its representatives, including but not limited to communication on electronic
 * mailing lists, source code control systems, and issue tracking systems that are managed by, or on behalf of, the
 * Licensor for the purpose of discussing and improving the Work, but excluding communication that is conspicuously
 * marked or otherwise designated in writing by the copyright owner as "Not a Contribution."
 *
 * "Contributor" shall mean Licensor and any individual or Legal Entity on behalf of whom a Contribution has been
 * received by Licensor and subsequently incorporated within the Work.
 *
 * 2. Grant of Copyright License. Subject to the terms and conditions of this License, each Contributor hereby grants to
 * You a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce,
 * prepare Derivative Works of, publicly display, publicly perform, sublicense, and distribute the Work and such
 * Derivative Works in Source or Object form.
 *
 * 3. Grant of Patent License. Subject to the terms and conditions of this License, each Contributor hereby grants to
 * You a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable (except as stated in this section)
 * patent license to make, have made, use, offer to sell, sell, import, and otherwise transfer the Work, where such
 * license applies only to those patent claims licensable by such Contributor that are necessarily infringed by their
 * Contribution(s) alone or by combination of their Contribution(s) with the Work to which such Contribution(s) was
 * submitted. If You institute patent litigation against any entity (including a cross-claim or counterclaim in a
 * lawsuit) alleging that the Work or a Contribution incorporated within the Work constitutes direct or contributory
 * patent infringement, then any patent licenses granted to You under this License for that Work shall terminate as of
 * the date such litigation is filed.
 *
 * 4. Redistribution. You may reproduce and distribute copies of the Work or Derivative Works thereof in any medium,
 * with or without modifications, and in Source or Object form, provided that You meet the following conditions:
 *
 * (a) You must give any other recipients of the Work or Derivative Works a copy of this License; and
 *
 * (b) You must cause any modified files to carry prominent notices stating that You changed the files; and
 *
 * (c) You must retain, in the Source form of any Derivative Works that You distribute, all copyright, patent,
 * trademark, and attribution notices from the Source form of the Work, excluding those notices that do not pertain to
 * any part of the Derivative Works; and
 *
 * (d) If the Work includes a "NOTICE" text file as part of its distribution, then any Derivative Works that You
 * distribute must include a readable copy of the attribution notices contained within such NOTICE file, excluding those
 * notices that do not pertain to any part of the Derivative Works, in at least one of the following places: within a
 * NOTICE text file distributed as part of the Derivative Works; within the Source form or documentation, if provided
 * along with the Derivative Works; or, within a display generated by the Derivative Works, if and wherever such
 * third-party notices normally appear. The contents of the NOTICE file are for informational purposes only and do not
 * modify the License. You may add Your own attribution notices within Derivative Works that You distribute, alongside
 * or as an addendum to the NOTICE text from the Work, provided that such additional attribution notices cannot be
 * construed as modifying the License.
 *
 * You may add Your own copyright statement to Your modifications and may provide additional or different license terms
 * and conditions for use, reproduction, or distribution of Your modifications, or for any such Derivative Works as a
 * whole, provided Your use, reproduction, and distribution of the Work otherwise complies with the conditions stated in
 * this License.
 *
 * 5. Submission of Contributions. Unless You explicitly state otherwise, any Contribution intentionally submitted for
 * inclusion in the Work by You to the Licensor shall be under the terms and conditions of this License, without any
 * additional terms or conditions. Notwithstanding the above, nothing herein shall supersede or modify the terms of any
 * separate license agreement you may have executed with Licensor regarding such Contributions.
 *
 * 6. Trademarks. This License does not grant permission to use the trade names, trademarks, service marks, or product
 * names of the Licensor, except as required for reasonable and customary use in describing the origin of the Work and
 * reproducing the content of the NOTICE file.
 *
 * 7. Disclaimer of Warranty. Unless required by applicable law or agreed to in writing, Licensor provides the Work (and
 * each Contributor provides its Contributions) on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT,
 * MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. You are solely responsible for determining the appropriateness
 * of using or redistributing the Work and assume any risks associated with Your exercise of permissions under this
 * License.
 *
 * 8. Limitation of Liability. In no event and under no legal theory, whether in tort (including negligence), contract,
 * or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in
 * writing, shall any Contributor be liable to You for damages, including any direct, indirect, special, incidental, or
 * consequential damages of any character arising as a result of this License or out of the use or inability to use the
 * Work (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or
 * any and all other commercial damages or losses), even if such Contributor has been advised of the possibility of such
 * damages.
 *
 * 9. Accepting Warranty or Additional Liability. While redistributing the Work or Derivative Works thereof, You may
 * choose to offer, and charge a fee for, acceptance of support, warranty, indemnity, or other liability obligations
 * and/or rights consistent with this License. However, in accepting such obligations, You may act only on Your own
 * behalf and on Your sole responsibility, not on behalf of any other Contributor, and only if You agree to indemnify,
 * defend, and hold each Contributor harmless for any liability incurred by, or claims asserted against, such
 * Contributor by reason of your accepting any such warranty or additional liability.
 *
 * END OF TERMS AND CONDITIONS
 *
 * APPENDIX: How to apply the Apache License to your work.
 *
 * To apply the Apache License to your work, attach the following boilerplate notice, with the fields enclosed by
 * brackets "[]" replaced with your own identifying information. (Don't include the brackets!) The text should be
 * enclosed in the appropriate comment syntax for the file format. We also recommend that a file or class name and
 * description of purpose be included on the same "printed page" as the copyright notice for easier identification
 * within third-party archives.
 *
 * Copyright [2018] [gclm]
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 */

package club.gclmit.gear4j.safe.xss;

import org.jsoup.Jsoup;
import org.jsoup.internal.StringUtil;
import org.jsoup.nodes.Attribute;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.nodes.Entities;
import org.springframework.web.util.HtmlUtils;

import club.gclmit.gear4j.core.lang.Log;
import club.gclmit.gear4j.core.lang.LoggerProvider;
import club.gclmit.gear4j.core.utils.StringUtils;
import club.gclmit.gear4j.safe.config.Gear4jXssProperties;
import cn.hutool.core.util.CharsetUtil;

/**
 * Xss Utils
 *
 * @author <a href="https://blog.gclmit.club">gclm</a>
 */
public class XssHandler {

    private XssHandler() {}

    public static final HtmlSafeList WHITE_LIST = HtmlSafeList.INSTANCE;

    private static final Document.OutputSettings DEFAULT_OUTPUT_SETTINGS =
        new Document.OutputSettings().prettyPrint(false);

    /**
     * 基于properties 处理xss <br>
     * 1. 非空判断 2. 判断处理模式，如果是转义，直接调用spring工具类处理 3. 如果是clean模式，需要根据自定义情况去配置清理参数
     *
     * @param properties xss 配置参数
     * @param text text
     * @return {@link String}
     */
    public static String clean(Gear4jXssProperties properties, String text) {
        if (StringUtil.isBlank(text)) {
            return text;
        }
        String result = text;
        Gear4jXssProperties.Mode mode = properties.getMode();
        if (Gear4jXssProperties.Mode.escape == mode) {
            result = HtmlUtils.htmlEscape(text, CharsetUtil.UTF_8);
        } else {
            Document.OutputSettings outputSettings = new Document.OutputSettings()
                // 这个规则最少
                .escapeMode(Entities.EscapeMode.xhtml).prettyPrint(properties.isPrettyPrint());
            String escapedHtml = Jsoup.clean(text, "", WHITE_LIST, outputSettings);

            // 转义判断，目前clean默认转义
            result = properties.isEnableEscape() ? escapedHtml : Entities.unescape(escapedHtml);
        }

        if (properties.isLog()) {
            Log.debug(LoggerProvider.GEAR4J, "Status: {}\tValue:[{}] -> [{}]", !result.equals(text), text, result);
        }
        return result;
    }

    /**
     * 自定义白名单
     */
    public static class HtmlSafeList extends org.jsoup.safety.Safelist {

        public static final HtmlSafeList INSTANCE = new HtmlSafeList();

        public HtmlSafeList() {
            addTags("a", "b", "blockquote", "br", "caption", "cite", "code", "col", "colgroup", "dd", "div", "span",
                "embed", "object", "dl", "dt", "em", "h1", "h2", "h3", "h4", "h5", "h6", "i", "img", "li", "ol", "p",
                "pre", "q", "small", "strike", "strong", "sub", "sup", "table", "tbody", "td", "tfoot", "th", "thead",
                "tr", "u", "ul");

            addAttributes("a", "href", "title", "target");
            addAttributes("blockquote", "cite");
            addAttributes("col", "span");
            addAttributes("colgroup", "span");
            addAttributes("img", "align", "alt", "src", "title");
            addAttributes("ol", "start");
            addAttributes("q", "cite");
            addAttributes("table", "summary");
            addAttributes("td", "abbr", "axis", "colspan", "rowspan", "width");
            addAttributes("th", "abbr", "axis", "colspan", "rowspan", "scope", "width");
            addAttributes("video", "src", "autoplay", "controls", "loop", "muted", "poster", "preload");
            addAttributes("object", "width", "height", "classid", "codebase");
            addAttributes("param", "name", "value");
            addAttributes("embed", "src", "quality", "width", "height", "allowFullScreen", "allowScriptAccess",
                "flashvars", "name", "type", "pluginspage");

            addAttributes(":all", "class", "style", "height", "width", "type", "id", "name");

            addProtocols("blockquote", "cite", "http", "https");
            addProtocols("cite", "cite", "http", "https");
            addProtocols("q", "cite", "http", "https");

            // 如果添加以下的协议，那么href 必须是http、 https 等开头，相对路径则被过滤掉了
            // addProtocols("a", "href", "ftp", "http", "https", "mailto", "tel");

            // 如果添加以下的协议，那么src必须是http 或者 https 开头，相对路径则被过滤掉了，
            // 所以必须注释掉，允许相对路径的图片资源
            // addProtocols("img", "src", "http", "https");
        }

        @Override
        protected boolean isSafeAttribute(String tagName, Element el, Attribute attr) {
            // 不允许 javascript 开头的 src 和 href
            if ("src".equalsIgnoreCase(attr.getKey()) || "href".equalsIgnoreCase(attr.getKey())) {
                String value = attr.getValue();
                if (StringUtils.isNotBlank(value) && value.toLowerCase().startsWith("javascript")) {
                    return false;
                }
            }
            // 允许 base64 的图片内容
            if ("img".equals(tagName) && "src".equals(attr.getKey()) && attr.getValue().startsWith("data:;base64")) {
                return true;
            }
            return super.isSafeAttribute(tagName, el, attr);
        }
    }
}
